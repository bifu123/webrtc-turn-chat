<!--chat.html-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>WebRTCèŠå¤©</title>
</head>
<body>
  <h3>ä½ çš„ID:</h3>
  <input id="self-id" />
  <h3>å¯¹æ–¹ID:</h3>
  <input id="peer-id" />
  <button id="register-btn">æ³¨å†Œå¹¶è¿æ¥</button>

  <h3>è¾“å…¥æ¶ˆæ¯:</h3>
  <input id="message-input" disabled />
  <button id="send-btn" disabled>å‘é€</button>

  <h3>æ—¥å¿—:</h3>
  <pre id="log"></pre>

  <script>
    const log = (msg) => {
      document.getElementById("log").textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    };

    let signalingSocket;
    let localConnection;
    let dataChannel;

    const config = {
      iceServers: [
        {
          urls: "turn:" + location.hostname + ":3478",
          username: "webrtcuser",
          credential: "123456"
        }
      ],
      iceTransportPolicy: "relay" // å¼ºåˆ¶èµ° TURN
    };

    document.getElementById("register-btn").onclick = () => {
      const selfId = document.getElementById("self-id").value.trim();
      const peerId = document.getElementById("peer-id").value.trim();
      if (!selfId || !peerId) return alert("è¯·å¡«å†™ID");

      signalingSocket = new WebSocket("ws://" + location.hostname + ":8765");

      signalingSocket.onopen = () => {
        signalingSocket.send(JSON.stringify({ type: "register", id: selfId }));
        log("ğŸŸ¢ æ³¨å†Œä¸º: " + selfId);
        startConnection(peerId);
      };

      signalingSocket.onmessage = async (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === "offer") {
          log("ğŸ“© æ”¶åˆ° offer");
          await handleOffer(msg.sdp, msg.from);
        } else if (msg.type === "answer") {
          log("ğŸ“© æ”¶åˆ° answer");
          await localConnection.setRemoteDescription(new RTCSessionDescription(msg.sdp));
        } else if (msg.type === "ice") {
          log("ğŸ“¡ æ”¶åˆ° ICE candidate");
          try {
            await localConnection.addIceCandidate(msg.candidate);
          } catch (e) {
            log("âŒ æ·»åŠ  ICE å¤±è´¥: " + e);
          }
        }
      };
    };

    async function startConnection(peerId) {
      localConnection = new RTCPeerConnection(config);

      dataChannel = localConnection.createDataChannel("chat");
      dataChannel.onopen = () => {
        log("âœ… æ•°æ®é€šé“å·²æ‰“å¼€");
        enableChat();
      };
      dataChannel.onmessage = (e) => log("ğŸ‘¤ å¯¹æ–¹: " + e.data);

      localConnection.onicecandidate = (event) => {
        if (event.candidate) {
          log("ğŸ“¡ ICE candidate: " + event.candidate.candidate);
          signalingSocket.send(JSON.stringify({
            type: "ice", to: peerId, candidate: event.candidate
          }));
        } else {
          log("ğŸŸ¢ æ‰€æœ‰å€™é€‰å·²æ”¶é›†å®Œæ¯•");
        }
      };

      localConnection.oniceconnectionstatechange = () => {
        log("ğŸ” ICE çŠ¶æ€: " + localConnection.iceConnectionState);
      };

      const offer = await localConnection.createOffer();
      await localConnection.setLocalDescription(offer);
      signalingSocket.send(JSON.stringify({
        type: "offer", to: peerId, sdp: localConnection.localDescription
      }));
    }

    async function handleOffer(offer, from) {
      localConnection = new RTCPeerConnection(config);

      localConnection.ondatachannel = (e) => {
        dataChannel = e.channel;
        dataChannel.onopen = () => {
          log("âœ… æ•°æ®é€šé“å·²æ‰“å¼€ï¼ˆè¢«åŠ¨ï¼‰");
          enableChat();
        };
        dataChannel.onmessage = (e) => log("ğŸ‘¤ å¯¹æ–¹: " + e.data);
      };

      localConnection.onicecandidate = (event) => {
        if (event.candidate) {
          log("ğŸ“¡ ICE candidate: " + event.candidate.candidate);
          signalingSocket.send(JSON.stringify({
            type: "ice", to: from, candidate: event.candidate
          }));
        } else {
          log("ğŸŸ¢ æ‰€æœ‰å€™é€‰å·²æ”¶é›†å®Œæ¯•");
        }
      };

      localConnection.oniceconnectionstatechange = () => {
        log("ğŸ” ICE çŠ¶æ€: " + localConnection.iceConnectionState);
      };

      await localConnection.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await localConnection.createAnswer();
      await localConnection.setLocalDescription(answer);
      signalingSocket.send(JSON.stringify({
        type: "answer", to: from, sdp: localConnection.localDescription
      }));
    }

    function enableChat() {
      const input = document.getElementById("message-input");
      const sendBtn = document.getElementById("send-btn");
      input.disabled = false;
      sendBtn.disabled = false;
      sendBtn.onclick = () => {
        const msg = input.value.trim();
        if (msg && dataChannel.readyState === "open") {
          dataChannel.send(msg);
          log("ğŸ—£ï¸ æˆ‘: " + msg);
          input.value = "";
        }
      };
    }
  </script>
</body>
</html>
